name: Dig via 8.8.8.8

on:
  workflow_dispatch:

jobs:
  k3s-test:
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      
      - uses: actions/checkout@v3
      - uses: ./.github/actions/dns-config
      
      - name: Start tcpdump
        run: |
          sudo tcpdump -i any -n udp port 53 > dns_capture.log 2>&1 &
          echo $! > tcpdump_pid.txt

      - run: |
          ip route get 54.185.253.63
          ip addr show lo
          sudo netstat -tulnp | grep :53
          sudo iptables -L -n 
      - name: Resolve microsoft.com using dig and 8.8.8.8
        run: |
          sudo apt update
          sudo apt install traceroute
          sudo traceroute -U -p 53 54.185.253.63
          echo "TEST" | nc -u -w1 54.185.253.63 53
          dig microsoft.com @54.185.253.63
        shell: bash

      - run: sudo iptables -L -v -n
        if: ${{ always() }}
      - run: sudo iptables -t nat -L -v -n
        if: ${{ always() }}
        
      - name: Display tcpdump output
        run: cat dns_capture.log
        if: always()
        
      - name: print logs
        if: always()
        run: sudo cat /tmp/tracer.log
